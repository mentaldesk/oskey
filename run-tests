#!/bin/sh
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Resolve the test path to an absolute path
if [ -n "$1" ]; then
    case "$1" in
        /*) TEST_PATH="$1" ;;
        *)  TEST_PATH="$SCRIPT_DIR/$1" ;;
    esac
else
    TEST_PATH="$SCRIPT_DIR/tests/oskey/"
fi

if ! command -v docker >/dev/null 2>&1; then
    echo "Error: Docker is required to run tests."
    echo "Install Docker Desktop: https://docs.docker.com/desktop/"
    exit 1
fi

DOCKER_TEST_PATH="/workspace${TEST_PATH#$SCRIPT_DIR}"
exec docker run --rm \
    -v "$SCRIPT_DIR:/workspace" \
    -v "$SCRIPT_DIR/build:/build" \
    -e "ZMK_TEST_PATH=$DOCKER_TEST_PATH" \
    -e ZMK_TESTS_AUTO_ACCEPT \
    zmkfirmware/zmk-build-arm:4.1 \
    bash -c '
        set -e
        cd /workspace/tests
        cmake -P /workspace/tests/zephyr/share/zephyr-package/cmake/zephyr_export.cmake
        cmake -P /workspace/tests/zephyr/share/zephyrunittest-package/cmake/zephyr_export.cmake
        ZEPHYR_TOOLCHAIN_VARIANT=host \
        ZMK_EXTRA_MODULES=/workspace \
        ZMK_SRC_DIR=/workspace/tests/zmk/app \
        /workspace/tests/zmk/app/run-test.sh "$ZMK_TEST_PATH"
    '
